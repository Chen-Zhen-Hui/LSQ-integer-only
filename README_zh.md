# LSQ-Integer-Only

ä¸€ä¸ªåŸºäºPyTorchçš„LSQï¼ˆLearned Step Size Quantizationï¼‰é‡åŒ–è®­ç»ƒå’Œæ•´æ•°æ¨ç†æ¡†æ¶ï¼Œæ”¯æŒè‡ªç”±æ—‹è½¬æƒé‡ã€æ¿€æ´»å€¼ä½æ¯”ç‰¹é‡åŒ–ã€‚

## é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®å®ç°äº†LSQé‡åŒ–ç®—æ³•ï¼Œæ”¯æŒï¼š
- **é‡åŒ–æ„ŸçŸ¥è®­ç»ƒï¼ˆQATï¼‰**ï¼šä½¿ç”¨LSQç®—æ³•è¿›è¡Œä½æ¯”ç‰¹é‡åŒ–è®­ç»ƒ
- **æ•´æ•°æ¨ç†**ï¼šæ”¯æŒçº¯æ•´æ•°è¿ç®—çš„æ¨¡å‹æ¨ç†
- **æ¨¡å‹æ¶æ„**ï¼šResNet/VGG
- **æ•°æ®é›†**ï¼šCIFAR/ImageNet

## ä¸»è¦ç‰¹æ€§

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½
- **LSQé‡åŒ–ç®—æ³•**ï¼šå®ç°Learned Step Size Quantization
- **W/Aé‡åŒ–**ï¼šæƒé‡å’Œæ¿€æ´»çš„é‡åŒ–æ¯”ç‰¹å¯è‡ªç”±é€‰æ‹©
- **æ•´æ•°æ¨ç†**ï¼šæ”¯æŒçº¯æ•´æ•°è¿ç®—çš„æ¨¡å‹æ¨ç†ï¼ˆçº¯å®šç‚¹ç¯å¢ƒï¼‰
- **BatchNormèåˆ**ï¼šè‡ªåŠ¨èåˆBatchNormå±‚ä»¥æé«˜æ¨ç†æ•ˆç‡


## é¡¹ç›®ç»“æ„

```
LSQ-integer-only/
â”œâ”€â”€ main.py              # æµ®ç‚¹æ¨¡å‹è®­ç»ƒè„šæœ¬
â”œâ”€â”€ q_main.py            # é‡åŒ–æ„ŸçŸ¥è®­ç»ƒè„šæœ¬
â”œâ”€â”€ q_inference.py       # æ•´æ•°æ¨ç†è„šæœ¬
â”œâ”€â”€ models/              # æ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ module.py        # LSQé‡åŒ–æ¨¡å—å®ç°
â”‚   â”œâ”€â”€ resnet.py        # ResNetæ¨¡å‹
â”‚   â”œâ”€â”€ resnet_cifar10.py # CIFAR-10ä¸“ç”¨ResNet
â”‚   â””â”€â”€ tiny_vgg.py      # TinyVGGæ¨¡å‹
â”œâ”€â”€ logs/                # æµ®ç‚¹è®­ç»ƒæ—¥å¿—
â”œâ”€â”€ qat_logs/            # é‡åŒ–è®­ç»ƒæ—¥å¿—
â””â”€â”€ README.md            # é¡¹ç›®è¯´æ˜æ–‡æ¡£
```

## å®‰è£…è¦æ±‚

### ç¯å¢ƒè¦æ±‚
- Python 3.7+
- PyTorch 1.8+
- CUDA 11.0+

### ä¾èµ–å®‰è£…
```bash
pip install torch torchvision
pip install tensorboard
pip install tqdm
```

## ä½¿ç”¨æ–¹æ³•

### 1. æµ®ç‚¹æ¨¡å‹è®­ç»ƒ

é¦–å…ˆè®­ç»ƒä¸€ä¸ªæµ®ç‚¹æ¨¡å‹ä½œä¸ºé‡åŒ–è®­ç»ƒçš„èµ·ç‚¹ï¼š

```bash
# è®­ç»ƒResNet18åœ¨CIFAR-10ä¸Š
python main.py \
    --model resnet18 \
    --dataset cifar10 \
    --epochs 200 \
    --batch-size 128 \
    --lr 0.1 \
    --cuda 0 \
    --amp
```

### 2. é‡åŒ–æ„ŸçŸ¥è®­ç»ƒ

ä½¿ç”¨LSQç®—æ³•è¿›è¡Œé‡åŒ–æ„ŸçŸ¥è®­ç»ƒï¼š

```bash
# W4A4é‡åŒ–è®­ç»ƒ
python q_main.py \
    --model resnet18 \
    --dataset cifar10 \
    --epochs 100 \
    --batch-size 128 \
    --lr 1e-3 \
    --w-num-bits 4 \
    --a-num-bits 4 \
    --cuda 0
```

### 3. æ•´æ•°æ¨ç†

ä½¿ç”¨è®­ç»ƒå¥½çš„é‡åŒ–æ¨¡å‹è¿›è¡Œæ•´æ•°æ¨ç†ï¼š

```bash
# æ•´æ•°æ¨ç†
python q_inference.py \
    --model resnet18 \
    --dataset cifar10 \
    --batch-size 128 \
    --w-num-bits 4 \
    --a-num-bits 4 \
    --cuda 0
```

## å‚æ•°è¯´æ˜

### è®­ç»ƒå‚æ•°
- `--model`: æ¨¡å‹ç±»å‹ (resnet18, resnet34, resnet_cifar10, tiny_vgg)
- `--dataset`: æ•°æ®é›† (cifar10)
- `--epochs`: è®­ç»ƒè½®æ•°
- `--batch-size`: è®­ç»ƒæ‰¹æ¬¡å¤§å°
- `--lr`: å­¦ä¹ ç‡
- `--cuda`: GPUè®¾å¤‡ID (-1è¡¨ç¤ºä½¿ç”¨CPU)

### é‡åŒ–å‚æ•°
- `--w-num-bits`: æƒé‡é‡åŒ–ä½æ•° (é»˜è®¤4)
- `--a-num-bits`: æ¿€æ´»é‡åŒ–ä½æ•° (é»˜è®¤4)
- `--resume`: ä»æ£€æŸ¥ç‚¹æ¢å¤è®­ç»ƒ

## LSQç®—æ³•åŸç†

LSQï¼ˆLearned Step Size Quantizationï¼‰æ˜¯ä¸€ç§å­¦ä¹ é‡åŒ–æ­¥é•¿çš„é‡åŒ–æ–¹æ³•ï¼š

1. **é‡åŒ–æ­¥é•¿å­¦ä¹ **ï¼šå°†é‡åŒ–æ­¥é•¿ä½œä¸ºå¯å­¦ä¹ å‚æ•°
2. **æ¢¯åº¦ç¼©æ”¾**ï¼šæ ¹æ®é‡åŒ–ä½å®½è°ƒæ•´æ¢¯åº¦
3. **STEè¿‘ä¼¼**ï¼šä½¿ç”¨Straight-Through Estimatorè¿›è¡Œæ¢¯åº¦ä¼ æ’­

### é‡åŒ–å…¬å¼
```
q = round(clamp(x/Î±, qmin, qmax))
x_q = Î± * q
```

å…¶ä¸­ï¼š
- `Î±` æ˜¯å¯å­¦ä¹ çš„é‡åŒ–æ­¥é•¿
- `qmin, qmax` æ˜¯é‡åŒ–èŒƒå›´
- `q` æ˜¯é‡åŒ–åçš„æ•´æ•°